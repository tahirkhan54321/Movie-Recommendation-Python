{% extends 'base.html' %} 
{% block title %}{{movie.title}}{% endblock %} 
{% load crispy_forms_tags %}
{% block content %}



<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2 p-3"> 

            <div class="card mb-3 p-3">
                <div class="card-body">
                    <h1 class="card-title">{{ movie.title }}</h1>

                    {% if user.is_authenticated %}
                        {% if movie in watchlist %}
                            <a href="{% url 'remove_from_watchlist' movie.movie_id %}" class="btn btn-outline-danger btn-sm">Remove from Watchlist</a>
                        {% else %}
                            <a href="{% url 'add_to_watchlist' movie.movie_id %}" class="btn btn-outline-success btn-sm">+ Add to Watchlist</a>
                        {% endif %}
                    {% endif %}

                    <button type="button" class="btn btn-primary btn-sm mt-2 {% if not movie.homepage %}disabled{% endif %}">
                        {% if movie.homepage %}
                            <a href="{{ movie.homepage }}" target="_blank" style="color: inherit; text-decoration: none;">Visit Movie Homepage</a>
                        {% else %}
                            Link Not Available
                        {% endif %}
                    </button>
                </div>
            </div> 

            <!-- DETAILS -->
            <div class="card mb-3 p-3">
                <div class="card-body">
                    <h2 class="card-title">Movie Details</h2>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Tagline:</strong> {{ movie.tagline }}</li>
                        <li class="list-group-item"><strong>Overview:</strong> {{ movie.overview }}</li>
                        <li class="list-group-item"><strong>Director:</strong> {{ movie.director }}</li>
                        <li class="list-group-item"><strong>Revenue:</strong> ${{ movie.revenue }}</li>
                        <li class="list-group-item"><strong>Budget:</strong> ${{ movie.budget }}</li>
                        <li class="list-group-item"><strong>Release Date:</strong> {{ movie.release_date }}</li>
                        <li class="list-group-item"><strong>Runtime:</strong> {{ movie.runtime }} minutes</li>
                    </ul>
                </div>
            </div>

            <!-- RATINGS -->
            <div class="card mb-3 p-3">
                <div class="card-body">
                    <h2 class="card-title">Ratings</h2>
                    <p><strong>Average Rating:</strong> 
                        {% if average_rating %}
                            {{ average_rating|floatformat:1 }}/5
                        {% else %}
                            Not rated yet
                        {% endif %}
                    </p>

                    {% if user.is_authenticated %}
                        <p><strong>Your Rating:</strong> 
                            {% if user_rating %}
                                {{ user_rating }}/5 
                            {% else %} 
                                You haven't rated this movie yet. 
                            {% endif %}
                        </p>
                        <form method="post" class="mb-3"> 
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="rating" class="form-label">Rate this movie (1-5):</label>
                                <select name="rating" id="rating" class="form-select">
                                    {% for i in '12345' %}
                                        <option value="{{ i }}" {% if user_rating == i %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Rating</button>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- REVIEWS -->
            <div class="card p-3"> 
                <div class="card-body">
                <h2 class="card-title">Reviews</h2>
                
                {% if user.is_authenticated %}
                    <h3>Add a Review</h3>
                        <form method="post">
                            {% csrf_token %}
                            {% for field in review_form %}
                                {{ field|as_crispy_field }}
                            {% endfor %}
                            <button type="submit" class="btn btn-primary mt-3">Submit Review</button>
                        </form>
                {% else %}
                    <p>Please log in to submit a review.</p>
                {% endif %}
                
                {% if reviews %}
                <ul class="list-group mt-3">
                    {% for review in reviews %}
                        <li class="list-group-item">
                            <h3>{{ review.title }}</h3>
                            <p>by {{ review.user.username }}</p>
                            <p>{{ review.review }}</p>
                        </li>
                    {% endfor %}
                </ul>
    
                    {% if reviews.has_other_pages %} 
                        <nav aria-label="Review pagination">
                            <ul class="pagination justify-content-center mt-3">
                                {% if reviews.has_previous %} 
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ reviews.previous_page_number }}" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
        
                                {% for num in reviews.paginator.page_range %}
                                    {% if reviews.number == num %}
                                        <li class="page-item active" aria-current="page">
                                            <a class="page-link" href="#">{{ num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
        
                                {% if reviews.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ reviews.next_page_number }}" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    </nav>
                {% endif %}
                </div>
            </div>

        </div> 
    </div> 
</div>

{% endblock %} 
